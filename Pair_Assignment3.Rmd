---
title: 'Pair Assignment 3: Gathering, Cleaning, Merging and Exploring our Data'
author: |
  | Malte Berneaud-Kötz & Jonas Markgraf
  | Hertie School of Governance
date: "14 April 2016"
output: pdf_document
subtitle: 'Course: Introduction to Collaborative Social Science Data Analysis'
header-includes:
- \usepackage{setspace}
- \doublespacing
---

# 1. Introduction[^3]
```{r setting_chunk_options, include=FALSE}
knitr::opts_chunk$set(fig.width=8, fig.height=6, fig.path='graphs/',
                      include = FALSE, warning=FALSE, message=FALSE,
                      cache = TRUE)
# Supressed output for any code chunk in the document, so all graphs, tables, 
# etc which need to have the outputs shown should use include = TRUE as an option
```

```{r fetching_packages}
 # Packages needed for the execution of this Rmd are listed in include.packages and checked against the installed packages on the machine executing the code. If they are not installed, they will be installed automatically.
include.packages <- c("dplyr", "ggplot2", "stringr", "readxl", "DataCombine")
  needed.packages <- include.packages[!(include.packages %in% installed.packages()[, "Package"])]
if(length(needed.packages)) install.packages(needed.packages, repos = "https://cran.uni-muenster.de/")
  
lapply(include.packages, library, character.only = TRUE)  # loading all packages at once
```

```{r loading_data}
SparkassenBoard <- read.table("data/BankBoards_Bavaria_RImport.txt", 
                        sep="\t", header = TRUE, fileEncoding ="UTF-16")
MayorElection <- read_excel("data/MayorElectionData.xlsx", sheet = "Bgm_OB")

```

# 2. Gathering the Data

## 2.1 *Sparkassen* Board Membership Data
We hand-collect a unique panel dataset on the composition of Boards of Directors in Bavaria's *Sparkassen*. This dataset includes detailed information on board member profiles which enables us to identify mayors on bank boards:

- name of board members;

- occupation of board members (identifier for mayors on board);

- position within board: normal board member, chairman, or vice chairman.

Annual information on Board of Directors is hand-collected from savings banks' annual reports available in PDF format on *Bundesanzeiger* for the years from 2006 to 2015; access to data prior 2006 is proprietary (Bureau van Djik's *Bankscope* database), which restricts our observation period. The dataset on boardroom composition constitutes the first comprehensive and systematic investigation of Bavarian savings banks' corporate governance as information on German public banks' boards has not been systematically collected yet.

## 2.2 Municipal Election Data
A database on mayoral elections in Bavaria is available from the state statistical office upon request. It contains data on direct municipal elections between 1948 and 2014. With this database we are covering 79 of the 416 German *Sparkassen* (19%) and 2,099 municipalities (19% of all municipalities in Germany). The data for mayoral elections contains the following variables:

- election date;
  
- name of election winner and (at least) the first loser;

- party affiliation of candidates;

- vote shares of candidates;
  
- dummy for competitive elections (at least two candidates);
  
- dummy for 'first-time mayor';

- number of eligible voters in voting district (size of municipality).

After obtaining the raw data, we cleaned the data set and subsequently created additional variables needed in our analysis. The individual steps taken are outline in the 

# 3. Cleaning the Data

## 3.1 *Sparkassen* Data
The data we obtained on the *Sparkassen* had really long and unwieldy names, which we changed to make them more manageable. Moreover, we standardized them to follow use underscores to seperate words and use lower case. 
```{r renaming_columns}
oldnames <- c("^name$", "^political...employee$", "^governing...opposition$", "retired.1.yes.",
              "^Incumbent$", "Name_CountyMunicipality", "Type_CountyMunicipality")
newnames <- c("name_candidate_1", "political_employee", "governing_opposition", "retired", "incumbent",
              "name_municipality", "type_county_municipality")
for (i in seq_along(oldnames)) {
  names(SparkassenBoard) <- gsub(oldnames[i], newnames[i], names(SparkassenBoard))
}

```

The strings containing the municipality names and the names of mayor candidates contained unnecessary whitespace which we trimmed using the str_trim function from the stringr package. 

```{r trimming_whitespace}
SparkassenBoard$name_municipality <- str_trim(SparkassenBoard$name_municipality)
SparkassenBoard$name_candidate_1 <- str_trim(SparkassenBoard$name_candidate_1)
```

Furthermore, we created an additional variable for top positions in *Sparkassen* boards. The raw data includes information on the position of the respective person (normal board member, vice chairman or chairman); since chairmen and vice chairmen alternate over the years in Bavarian savings banks, there is no difference between chairmen and vice chairmen in reality and they can be amalgamated into one category (*top position*).

```{r creating new variable for top position}
SparkassenBoard$TopPosition <- 0
SparkassenBoard$TopPosition[SparkassenBoard$chair != "no"] <- 1
SparkassenBoard$TopPosition <- as.character(SparkassenBoard$TopPosition)

```

Finally, we created three sub-data frames by subsetting the initial dataframe in order to analyze different aspects of *Sparkassen* boards in greater detail. Hence, we created a subset containing unique board member profiles, another one with unique profiles of mayors on the board, and a data frame with only persons in top positions on the board.

```{r subsetting dataframe}
# Create sub-dataframes
## :unique board members
SparkassenBoard_UniqueMembers <- unique(SparkassenBoard[,c("name_candidate_1", "occupation", "incumbent", "TopPosition",
                                      "name_municipality")])
## :mayors at board
SparkassenBoard_UniqueBoardMayors <- subset(SparkassenBoard_UniqueMembers, incumbent == "1")
## :Top Positions only
SparkassenBoard_TopPositions <- subset(SparkassenBoard, TopPosition == 1)

```

## 3.2 Creating Additional Variables
In addition to the variables available in the data set already, we created variables (1) distinguishing 'first time mayors', (2) identifying competitive elections where there were more than one candidate, (3) the number of times a single mayor was elected, which allowed us to identify mayor's first re-election. This last point is important because our research is interested in the first re-election of mayors specifically. 

## 3.3 Municipal Election Data
The municipal election data as provided by the Bavarian Statistical Service was provided as an Excel worksheet, which also meant that the columns where named in a way which was not computer-readable. As a result, we had to clean the names of the data set almost entirely. Aside from containing spaces, they also frequently contained line breaks and carriage returns.

```{r cleaning_names_municipality_elections}
# removing newlines
names(MayorElection) <- str_replace_all(names(MayorElection), "[\r\n]" , "")  
# removing punctuation
names(MayorElection) <- gsub("[[:punct:]]", "", names(MayorElection))
# removing whitespace
names(MayorElection) <- str_trim(names(MayorElection))
# correcting "Geschlecht"
names(MayorElection) <- gsub("^Geschl", "Geschlecht", names(MayorElection))

# Changing label names
newnames <- c("IDMunicipality","NameMunicipality", "ElectionDate", "RunOffNecessary", "ElectionType", "ProfPolitician", "NumberEligVoter", "NumberVoters", "InvalBallots", "ValBallots", "NameCandidate1")

names(MayorElection)[1:11] <- newnames

names(MayorElection) <- gsub("gültigeStimmen 1", "VotesCandidate1", names(MayorElection))
names(MayorElection) <- gsub("Stimmen für nicht genannte Bewerber zusammen", "VotesRest", names(MayorElection))

```
Aside from the variables included in the data set, we extracted information on PhD titles from the names of the candidates from the variable for candidate's name and created a new variable indicating whether the person has a Dr. title or not; this was necessary in order to merge the *Sparkassen* dataset and the Mayor Election dataset because name and title of board members was collected as two separate variables. Additionally, we created a variable which indicates whether or not the election of the mayor is contested. We want to use this variable in subsetting our data set later, as it identifies mayors which could have possibly leveraged their position in a *Sparkassen* board to secure re-election. 

```{r additional_variables}
# Extracting Phd titles
MayorElection$Phd <- NA
MayorElection$Phd <- ifelse(grepl("Dr.", MayorElection$NameCandidate1), 1, 0)
MayorElection$NameCandidate1 <- gsub(" Dr.", "", MayorElection$NameCandidate1)
MayorElection$NameCandidate1 <- gsub(" jur.", "", MayorElection$NameCandidate1)

# creating re-election dummy
MayorElection$Reelection <- NA
for(i in 2:nrow(MayorElection)) {
  if(MayorElection$NameCandidate1[i] == MayorElection$NameCandidate1[i-1]) {
    MayorElection$Reelection[i] <- 1
  } else {
    MayorElection$Reelection[i] <- 0
  }
}

# creating the total number of terms for each mayor
tally <- dplyr::tally(group_by(MayorElection, NameCandidate1))
names(tally)[2] <- "TotalTerms"
#merging that back into the data frame
MayorElection <- merge(MayorElection, tally)

# Extracting years from the election date character string
MayorElection$Year <- strtrim(MayorElection$ElectionDate, 4L)

# TODO: creating variable indicating number of terms
```

# 4. Merging the Data
As we want to conduct our analysis on the mayor-election level, the data set was merged on the names of the mayors and years. 

```{r merging_data_sets}
# Merging the data sets
Merge <- merge(MayorElection, SparkassenBoard, by.x = c("NameCandidate1", "Year"),
               by.y = c("name_candidate_1", "year"), all.x = TRUE)

# creating a dummy which indicates if a mayor had been a member of the board of his local Sparkasse in the election year
# coercing factor to characters in variable used to identify mayors
Merge$bank_name <- as.character(Merge$bank_name)
Merge$MayorSparkasse <- ifelse(nchar(Merge$bank_name) > 2, 1, 0)
```

In order to analyze whether mayors with a board seat in a public savings bank are more likely to be re-elected, we need know whether a mayor was board member in a *Sparkasse*. While we have detailed information about a mayor's profile in the Municipal Election data frame, we lack information about his or her connection to a *Sparkasse*; this information we get from our *Sparkassen* Board Membership dataset. In order to combine this information with the Election dataset, we add a variable to our Election dataset indicating whether the name of election winner is listed in our Board Membership dataset, i.e. if the mayor has a board seat[^1].

```{r Adding variable for Board Membership to Election data frame}
##: variable for board membership
MayorElection$SparkassenMember <- is.element(MayorElection$NameCandidate1, 
                                            unique(SparkassenBoard$NameCandidate1))
```

However, as we are interested in whether the incumbent (and not the election winner) was holding a board seat, we had to add another variable indicating if the election winner of the previous election (i.e. the incumbent) was a board member.

```{r Adding variable for Board Membership of Incumbent}
##: variable for board membership of incumbent
library(DataCombine)
MayorElection <- slide(MayorElection, Var = "SparkassenMember",
                       NewVar = "IncumbentSparkassenMember")
```

# 5. Descriptive Statistics


## 5.1. Sparkassen Dataset
```{r sparkassen_top_positions, include=TRUE, echo=FALSE, fig.height=8, fig.width=10}
ggplot(SparkassenBoard, aes(TopPosition, frequency(TopPosition))) + 
  geom_bar(stat = "identity") +
  xlab("") +
  ylab("Number of Seats") +
  ggtitle("Number of Top Positions in Boards")
```

```{r politicians_in_Sparkassen_board, include=TRUE, echo=FALSE, fig.height=8, fig.width=10}
barplot(table(SparkassenBoard_TopPositions$incumbent),
        main = "Share of Politicians in Top Positions on Bank Board",
        names.arg = c("Non-Political", "Mayor", "Landrat"),
        ylab = "Board Members in Top Positions")

```


```{r top_positions_vs_entire_board, }
ggplot(SparkassenBoard, aes(TopPosition, frequency, fill = incumbent)) +
  geom_bar(aes(y = (..count..)), position=position_dodge(), width=1) +
  xlab("") +
  scale_x_discrete(limit= c("0", "1"),
                   labels=c("Non-Top Positions", "Top Positions")) +
  ylab("Number of Board Members") +
  theme(legend.position = "bottom") +
  scale_fill_discrete(name="Political Position",
                      breaks=c("0", "1", "2"),
                      labels=c("No Full-Time Politician", "Mayor", "County Commissioner"))
```

As outlined above, the *Sparkassen* dataset contains information on names, political position (no full-time politician; mayor; county commissioner) and position within the board (top position; non-top position). This allows us the estimate the degree of politicization of boards and the patterns of politicization.

## 5.2. Election Dataset

## 5.3. Merged Dataset

# 6. First Inferences

[^1]: As the focus of this paper is the analysis of the electoral effect of board membership, we focus on the re-election chances of mayors with board membership in a *Sparkasse* compared to those without a board seat. A closer examination of the patterns of politicization of banks' boards, such as partisanship within boards, is therefore not conducted and goes beyond the scope of this paper. Future steps of the PhD research project will, however, analyze those patterns.

[^3]: This paper is based on and a part of a research project by Guillermo Rosas (Washington University in St. Louis; grosas@wustl.edu) and Jonas Markgraf (Hertie School of Governance; markgraf@hertie-school.org).